from django.db import models

import subprocess
import os
import uuid

class Tools():

    def create_key():

        # create key
        tmpkeyname = str(uuid.uuid4())
        keycmd = "openvpn --genkey --secret /tmp/%s.key" % tmpkeyname
        print(keycmd)
        p = subprocess.Popen(keycmd, stdin=subprocess.PIPE, stdout=subprocess.PIPE, shell=True)
        if p.wait() != 0:
            raise Exception("could not create temp key")
        with open("/tmp/%s.key" % tmpkeyname, 'r') as tmpk:
            key = tmpk.readlines()
        os.remove("/tmp/%s.key" % tmpkeyname)


        return ''.join(key)


class Openvpn(models.Model):
    name = models.CharField(max_length=255, unique=True)
    description = models.TextField(blank=True, null=True)
    port = models.IntegerField(default=1194)
    tun_ip = models.GenericIPAddressField()
    config = models.CharField(max_length=255, blank=True, null=True, editable=False)
    start_on_boot = models.BooleanField(default=False)

    def __str__(self):
        return self.name

    def control(self, command):
        cmd = "sudo /usr/local/bin/controlvpn.sh %s %s" % (self.config, command)
        p = subprocess.Popen(cmd, stdin=subprocess.PIPE, stdout=subprocess.PIPE, shell=True)
        p.wait() 

class OpenvpnClient(Openvpn):
    gateway = models.CharField(max_length=255)
    server_ip = models.GenericIPAddressField()
    static_key = models.TextField()

    def save(self, *args, **kwargs):
        configfile = "/tmp/client-%s.conf" % self.name
        keyfile = "/tmp/client-%s.key" % self.name
        with open(keyfile, "w") as kf:
            kf.write(self.static_key)
        with open(configfile, "w") as cf:
            cf.write("# autogenerated configuration\n")
            cf.write("# for %s. Do not edit!\n" % self.name)
            cf.write("remote %s\n" % self.gateway)
            cf.write("port %d\n" % self.port)
            cf.write("dev tun\n")
            cf.write("ifconfig %s %s\n" % (self.tun_ip, self.server_ip))
            cf.write("secret client%s.key" % self.name)

        deploycmd = "sudo /usr/local/bin/deployconfig.sh client-%s" % self.name
        p = subprocess.Popen(deploycmd, stdin=subprocess.PIPE, stdout=subprocess.PIPE, shell=True)
        if p.wait() != 0:
            raise Exception("could not deploy config and/or key file(s)")

        self.config = "client-%s" % self.name

        if self.start_on_boot:
            self.control("enable")

        super(OpenvpnClient, self).save(*args, **kwargs)

    def delete(self, *args, **kwargs):
        rmcmd = "sudo /usr/local/bin/rmconfig.sh client-%s" % self.name
        p = subprocess.Popen(rmcmd, stdin=subprocess.PIPE, stdout=subprocess.PIPE, shell=True)
        if p.wait() != 0:
            raise Exception("could not delete config and/or key file(s)")

        try:
            self.control("stop")
        except:
            pass
        try:
            self.control("disable")
        except:
            pass

        super(OpenvpnClient, self).delete(*args, **kwargs)

class OpenvpnServer(Openvpn):
    client_ip = models.GenericIPAddressField()
    static_key = models.TextField(default=Tools.create_key())

    def save(self, *args, **kwargs):
        configfile = "/tmp/server-%s.conf" % self.name
        keyfile = "/tmp/server-%s.key" % self.name
        with open(keyfile, "w") as kf:
            kf.write(self.static_key)
        with open(configfile, "w") as cf:
            cf.write("# autogenerated configuration\n")
            cf.write("# for %s. Do not edit!\n" % self.name)
            cf.write("port %d\n" % self.port)
            cf.write("dev tun\n") 
            cf.write("ifconfig %s %s" % (self.tun_ip, self.client_ip))
            cf.write("secret server-%s.key" % self.name)

        deploycmd = "sudo /usr/local/bin/deployconfig.sh server-%s" % self.name
        p = subprocess.Popen(deploycmd, stdin=subprocess.PIPE, stdout=subprocess.PIPE, shell=True)
        if p.wait() != 0:
            raise Exception("could not deploy config and/or key file(s)")

        self.config = "server-%s" % self.name

        if self.start_on_boot:
            self.control("enable")

        super(OpenvpnServer, self).save(*args, **kwargs)

    def delete(self, *args, **kwargs):
        rmcmd = "sudo /usr/local/bin/rmconfig.sh server-%s" % self.name
        p = subprocess.Popen(rmcmd, stdin=subprocess.PIPE, stdout=subprocess.PIPE, shell=True)
        if p.wait() != 0:
            raise Exception("could not delete config and/or key file(s)")

        try:
            self.control("stop")
        except:
            pass
        try:
            self.control("disable")
        except:
            pass

        super(OpenvpnServer, self).delete(*args, **kwargs)


